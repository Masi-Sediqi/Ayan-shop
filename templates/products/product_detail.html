{% extends 'base.html' %}
{% load static %}
{% block content %}
	<main class="wrapper sb-default">
		<!-- Main Content -->
		<div class="mn-main-content">
			<div class="mn-breadcrumb m-b-30">
				<div class="row">
					<div class="col-12">
						<div class="row gi_breadcrumb_inner">
							<div class="col-md-6 col-sm-12">
								<h2 class="mn-breadcrumb-title">Product Page</h2>
							</div>
							<div class="col-md-6 col-sm-12">
								<!-- mn-breadcrumb-list start -->
								<ul class="mn-breadcrumb-list">
									<li class="mn-breadcrumb-item"><a href="/">Home</a></li>
									<li class="mn-breadcrumb-item active">Product Page</li>
								</ul>
								<!-- mn-breadcrumb-list end -->
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-xxl-12">
					<section class="mn-single-product">
						<div class="row">
							<div class="mn-pro-rightside mn-common-rightside col-lg-9 col-md-12 m-b-15">
								<!-- Single product content Start -->
								<div class="single-pro-block">
									<div class="single-pro-inner">
										<div class="row">
										<div class="single-pro-img">
                                            <div class="single-product-scroll">
                                                <div class="single-product-cover">
                                                    {% for img in variant_images %}
                                                        <div class="single-slide zoom-image-hover">
                                                            <img class="img-responsive" src="{{ img.url }}" alt="{{ img.alt_text|default:product.name }}">
                                                        </div>
                                                    {% empty %}
                                                        <div class="single-slide">
                                                            <img class="img-responsive" src="{% static 'assets/img/no-image.png' %}" alt="No image available">
                                                        </div>
                                                    {% endfor %}
                                                </div>

                                                <div class="single-nav-thumb">
                                                    {% for img in variant_images %}
                                                        <div class="single-slide">
                                                            <img class="img-responsive" src="{{ img.url }}" alt="{{ img.alt_text|default:product.name }}">
                                                        </div>
                                                    {% empty %}
                                                        <div class="single-slide">
                                                            <img class="img-responsive" src="{% static 'assets/img/no-image.png' %}" alt="No image available">
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>

											<div class="single-pro-desc m-t-991">
												<div class="single-pro-content">
													<h5 class="mn-single-title">{{ product.name }}</h5>

													<div class="mn-single-price-stoke">
														<div class="mn-single-price">
                                                            <div class="mn-price">
                                                                {% if discount_percent > 0 %}
                                                                    <div class="mn-price-old">${{ original_price|floatformat:2 }}</div>
                                                                    <div class="final-price">
                                                                        ${{ final_price|floatformat:2 }}
                                                                        <span class="price-des">-{{ discount_percent|floatformat:0 }}%</span>
                                                                    </div>
                                                                {% else %}
                                                                    <div class="final-price">${{ original_price|floatformat:2 }}</div>
                                                                {% endif %}
                                                            </div>
															<!-- <div class="mrp">M.R.P. : <span>$2,999.00</span></div> -->
														</div>
														<div class="mn-single-stoke">
															{% if variant.stock > 0 %}
																<span class="mn-single-ps-title text-success">IN STOCK</span>
															{% else %}
																<span class="mn-single-ps-title text-danger">OUT OF STOCK</span>
															{% endif %}
														</div>
													</div>
												<div class="mn-single-sales">
                                                    <div class="mn-single-sales-inner">
                                                      

                                                        {% if discount_end %}
                                                        <div class="mn-single-sales-countdown">
                                                            <div class="mn-single-countdown">
                                                            <div id="deal-countdown" class="timer1 timer dealend-timer" data-date="{{ discount_end }}"></div>
                                                            <div class="mn-single-count-desc">Time is Running Out!</div>
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                        </div>
                                                    </div>
                                                    <script>
                                                    function startCountdown(elementId) {
                                                        const el = document.getElementById(elementId);
                                                        const endTime = new Date(el.dataset.date).getTime();

                                                        const timer = setInterval(function() {
                                                            const now = new Date().getTime();
                                                            const distance = endTime - now;

                                                            if (distance < 0) {
                                                                clearInterval(timer);
                                                                el.innerHTML = "EXPIRED";
                                                                return;
                                                            }

                                                            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                                                            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                                            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                                                            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                                                            el.innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
                                                        }, 1000);
                                                    }

                                                    document.addEventListener("DOMContentLoaded", function() {
                                                        if(document.getElementById("deal-countdown")){
                                                            startCountdown("deal-countdown");
                                                        }
                                                    });
                                                    </script>

                                                    <div class="mn-single-desc"> {{ product.description }} .</div>

											
													<div class="mn-pro-variation">
														<div class="mn-pro-variation">
                                                            <div class="mn-pro-variation-inner mn-pro-variation-size m-b-24">
                                                                <span>Sizes</span>
                                                                <div class="mn-pro-variation-content">
                                                                  <form method="post" action="{% url 'products:product_details' product.id %}">
																	{% csrf_token %}
																	<ul>
																		{% for size in sizes %}
																			<li>
																				<button type="submit" name="size_id" value="{{ size.id }}"
																					style="background:none; border:none; cursor:pointer;
																						{% if selected_size and size.id == selected_size.id %}font-weight:bold;text-decoration:underline{% endif %}">
																					{{ size.size|upper }}
																				</button>
																			</li>
																		{% endfor %}
																	</ul>
																</form>

                                                                </div>
                                                            </div>
                                                        </div>
														<div class="mn-pro-variation-inner mn-pro-variation-color">
                                                            <span>Colors</span>
                                                            <div class="mn-pro-variation-content">
                                                                <ul>
																	<div class="product-colors">
																		<form method="post" action="{% url 'products:product_details' product.id %}">
																			{% csrf_token %}
																			<div style="display:flex; gap:5px;">
																				{% for color in colors %}
																					<button type="submit" name="color_id" value="{{ color.id }}"
																						style="background-color: {{ color.color }};
																							width:28px; height:28px; border-radius:50%;
																							border: {% if selected_color and color.id == selected_color.id %}2px solid black{% else %}1px solid #ccc{% endif %};">
																					</button>
																				{% endfor %}
																			</div>
																		</form>
																	</div>
                                                                </ul>
                                                            </div>
                                                        </div>
													</div>
													<div class="mn-single-qty">
														<div class="mn-btns">
															<div class="mn-single-cart">
																<!-- <button
																	class="btn btn-primary mn-btn-2 mn-add-cart"><span>Share on WhatsApp</span></button> -->
																{% if variant and variant.image %}
																	<a href="https://wa.me/93777040973?text={{ product.name|urlencode }}%0A{{ request.build_absolute_uri|urlencode }}%0A{{ request.build_absolute_uri|add:variant.image.url|urlencode }}%0A%0Agive some more info about this"
																	target="_blank"
																	class="btn btn-primary mn-btn-2 mn-add-cart">
																	<svg xmlns="http://www.w3.org/2000/svg" width="23.82" height="24" viewBox="0 0 256 258"><defs><linearGradient id="SVGBRLHCcSy" x1="50%" x2="50%" y1="100%" y2="0%"><stop offset="0%" stop-color="#1faf38"/><stop offset="100%" stop-color="#60d669"/></linearGradient><linearGradient id="SVGHW6lecxh" x1="50%" x2="50%" y1="100%" y2="0%"><stop offset="0%" stop-color="#f9f9f9"/><stop offset="100%" stop-color="#fff"/></linearGradient></defs><path fill="url(#SVGBRLHCcSy)" d="M5.463 127.456c-.006 21.677 5.658 42.843 16.428 61.499L4.433 252.697l65.232-17.104a123 123 0 0 0 58.8 14.97h.054c67.815 0 123.018-55.183 123.047-123.01c.013-32.867-12.775-63.773-36.009-87.025c-23.23-23.25-54.125-36.061-87.043-36.076c-67.823 0-123.022 55.18-123.05 123.004"/><path fill="url(#SVGHW6lecxh)" d="M1.07 127.416c-.007 22.457 5.86 44.38 17.014 63.704L0 257.147l67.571-17.717c18.618 10.151 39.58 15.503 60.91 15.511h.055c70.248 0 127.434-57.168 127.464-127.423c.012-34.048-13.236-66.065-37.3-90.15C194.633 13.286 162.633.014 128.536 0C58.276 0 1.099 57.16 1.071 127.416m40.24 60.376l-2.523-4.005c-10.606-16.864-16.204-36.352-16.196-56.363C22.614 69.029 70.138 21.52 128.576 21.52c28.3.012 54.896 11.044 74.9 31.06c20.003 20.018 31.01 46.628 31.003 74.93c-.026 58.395-47.551 105.91-105.943 105.91h-.042c-19.013-.01-37.66-5.116-53.922-14.765l-3.87-2.295l-40.098 10.513z"/><path fill="#fff" d="M96.678 74.148c-2.386-5.303-4.897-5.41-7.166-5.503c-1.858-.08-3.982-.074-6.104-.074c-2.124 0-5.575.799-8.492 3.984c-2.92 3.188-11.148 10.892-11.148 26.561s11.413 30.813 13.004 32.94c1.593 2.123 22.033 35.307 54.405 48.073c26.904 10.609 32.379 8.499 38.218 7.967c5.84-.53 18.844-7.702 21.497-15.139c2.655-7.436 2.655-13.81 1.859-15.142c-.796-1.327-2.92-2.124-6.105-3.716s-18.844-9.298-21.763-10.361c-2.92-1.062-5.043-1.592-7.167 1.597c-2.124 3.184-8.223 10.356-10.082 12.48c-1.857 2.129-3.716 2.394-6.9.801c-3.187-1.598-13.444-4.957-25.613-15.806c-9.468-8.442-15.86-18.867-17.718-22.056c-1.858-3.184-.199-4.91 1.398-6.497c1.431-1.427 3.186-3.719 4.78-5.578c1.588-1.86 2.118-3.187 3.18-5.311c1.063-2.126.531-3.986-.264-5.579c-.798-1.593-6.987-17.343-9.819-23.64"/></svg> WhatsApp
																	</a>
																{% endif %}
															</div>
														<div class="mn-single-wishlist">
															<a href="{% url 'products:toggle_like' product.id %}"
															class="mn-btn-group wishlist mn-wishlist"
															title="Wishlist">
																<i class="ri-heart{% if user in product.liked_by.all %}-fill{% else %}-line{% endif %}"></i>
															</a>
														</div>

															<div class="mn-single-mn-compare">
																<a href="javascript:void(0)"
																	class="mn-btn-group mn-compare" title="Quick view">
																	<i class="ri-repeat-line"></i>
																</a>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
								<!--Single product content End -->
								<!-- Add More and get discount content Start -->
								<div class="single-add-more m-tb-30">
									<div class="mn-add-more-slider owl-carousel">
										
									</div>
								</div>
								<!-- Single product tab start -->
								<div class="mn-single-pro-tab">
									<div class="mn-single-pro-tab-wrapper">
										<div class="mn-single-pro-tab-nav">
											<ul class="nav nav-tabs" id="myTab" role="tablist">
												<li class="nav-item" role="presentation">
													<button class="nav-link active" id="details-tab"
														data-bs-toggle="tab" data-bs-target="#mn-spt-nav-details"
														type="button" role="tab" aria-controls="mn-spt-nav-details"
														aria-selected="true">Detail</button>
												</li>
											
												<li class="nav-item" role="presentation">
													<button class="nav-link" id="review-tab" data-bs-toggle="tab"
														data-bs-target="#mn-spt-nav-review" type="button" role="tab"
														aria-controls="mn-spt-nav-review"
														aria-selected="false">Reviews</button>
												</li>
											</ul>

										</div>
										<div class="tab-content  mn-single-pro-tab-content">
											<div id="mn-spt-nav-details" class="tab-pane fade show active">
												<div class="mn-single-pro-tab-desc">
													<p>
													The <strong>{{ product.name }}</strong> belongs to the 
													<strong>{{ product.category.name }}</strong> category.
													{% if selected_color %}
														It is currently shown in the <strong>{{ selected_color.name }}</strong> color.
													{% endif %}
													{% if selected_size %}
														The selected size is <strong>{{ selected_size.name }}</strong>.
													{% endif %}

													{% if discount_percent %}
														It currently has a <strong>{{ discount_percent }}%</strong> discount,
														{% if discount_end %} valid until <strong>{{ discount_end|date:"F j, Y" }}</strong>.{% else %}available for a limited time.{% endif %}
														The discounted price is <strong>{{ final_price|floatformat:2 }} Afs</strong>,
														down from <del>{{ original_price|floatformat:2 }} Afs</del>.
													{% else %}
														The price of this product is <strong>{{ original_price|floatformat:2 }} Afs</strong>.
													{% endif %}

													{% if sizes %}
														Available sizes include:
														{% for s in sizes %}
															<span class="badge bg-light text-dark border m-1">{{ s.name }}</span>
														{% endfor %}
													{% endif %}

													{% if colors %}
														Available colors:
														{% for c in colors %}
															<span class="badge bg-light text-dark border m-1">{{ c.name }}</span>
														{% endfor %}
													{% endif %}

													<br><br>
													To continue your purchase, click the WhatsApp button below 👇
													</p>
												</div>
											</div>
											<div id="mn-spt-nav-review" class="tab-pane fade">
												<div class="row">
													<div class="mn-t-review-wrapper mt-0">
														{% for review in product_reviews %}
														<div class="mn-t-review-item">
															<div class="mn-t-review-avtar">
																<img src="{{ review.image.url }}" alt="user">
															</div>
															<div class="mn-t-review-content">
																<div class="mn-t-review-top">
																	<div class="mn-t-review-name">{{ review.name }}</div>
																	<div class="mn-t-review-rating mn-pro-rating">
																		{% for i in "12345" %}
																			{% if forloop.counter <= review.rating %}
																				<i class="ri-star-fill"></i>
																			{% else %}
																				<i class="ri-star-fill grey"></i>
																			{% endif %}
																		{% endfor %}
																	</div>
																</div>
																<div class="mn-t-review-bottom">
																	<p>{{ review.detail }}
																	</p>
																</div>
															</div>
														</div>
														{% endfor %}
													</div>
													<div class="mn-ratting-content">
														<h3>Add a Review</h3>
														<div class="mn-ratting-form">
															<form action="{% url 'products:submit_review' product.id %}" method="POST" enctype="multipart/form-data">
																{% csrf_token %}
																<div class="mn-ratting-star">
																	<span>Your rating:</span>
																	<div class="mn-t-review-rating mn-pro-rating" id="rating-stars">
																		<i class="ri-star-fill" data-value="1"></i>
																		<i class="ri-star-fill" data-value="2"></i>
																		<i class="ri-star-fill" data-value="3"></i>
																		<i class="ri-star-fill" data-value="4"></i>
																		<i class="ri-star-fill" data-value="5"></i>
																	</div>
																	<input type="hidden" name="rating" id="rating-value" value="5">
																</div>

																<div class="mn-ratting-input">
																	<input name="your-name" placeholder="Name" type="text" required>
																</div>

																<!-- 🖼️ Image upload field instead of email -->
																<div class="mn-ratting-input">
																	<label class="form-label">Your Image (optional)</label>
																	<input name="your-image" type="file" accept="image/*">
																</div>

																<div class="mn-ratting-input form-submit">
																	<textarea name="your-commemt" placeholder="Enter Your Comment"></textarea>
																	<button class="mn-btn-2" type="submit"><span>Submit</span></button>
																</div>
															</form>

															<script>
																const stars = document.querySelectorAll('#rating-stars i');
																const ratingInput = document.getElementById('rating-value');

																stars.forEach(star => {
																	star.addEventListener('click', function() {
																		const value = this.getAttribute('data-value');
																		ratingInput.value = value;
																		stars.forEach(s => {
																			s.classList.toggle('grey', s.getAttribute('data-value') > value);
																		});
																	});
																});
															</script>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
								<!-- Related Section -->
								<section class="mn-related-product m-t-30">
									<div class="mn-title">
										<h2>Related <span>Products</span></h2>
									</div>
									<div class="mn-related owl-carousel">
										{% for i in related_products %}
										<div class="mn-product-card">
											<div class="mn-product-img">
												<div class="lbl">
													<span class="trending">trending</span>
												</div>
												<div class="mn-img">
													<a href="product-detail.html" class="image">
														<img class="main-img" src="{{ i.first_variant.image.url }}"
															alt="product">
														<img class="hover-img" src="{{ i.first_variant.image_hover.url }}"
															alt="product">
													</a>
													<div class="mn-pro-loader"></div>
													<div class="mn-options">
														<ul>
															<li><a href="javascript:void(0)" data-tooltip
																	title="Quick View" data-link-action="quickview"
																	data-bs-toggle="modal"
																	data-bs-target="#quickview_modal">
																	<i class="ri-eye-line"></i></a></li>
															<li><a href="javascript:void(0)" data-tooltip
																	title="Compare" class="mn-compare"><i
																		class="ri-repeat-line"></i></a>
															</li>
															<li><a href="javascript:void(0)" data-tooltip
																	title="Add To Cart" class="mn-add-cart"><i
																		class="ri-shopping-cart-line"></i></a></li>
														</ul>
													</div>
												</div>
											</div>
											<div class="mn-product-detail">
												<div class="cat">
													<a href="shop-right-sidebar.html">{{ i.product.category.name }}</a>
													<ul>
														{% for s in i.sizes %}
															<li>{{ s|upper }}</li>
														{% endfor %}
													</ul>
												</div>
												<h5><a href="">Cotton fabric T-shirt</a></h5>
												<div class="mn-price">
													{% if i.has_discount %}
														<div class="mn-price-new">${{ i.final_price|floatformat:2 }}</div>
														<div class="mn-price-old">${{ i.original_price|floatformat:2 }}</div>
													{% else %}
														<div class="mn-price-new">${{ i.final_price|floatformat:2 }}</div>
													{% endif %}
												</div>
												<div class="mn-pro-option">
													<div class="mn-pro-color">
														<ul class="mn-opt-swatch mn-change-img">
															{% for c in i.colors %}
															<li>
																<a href="javascript:void(0);" class="mn-opt-clr-img"
																data-src="{{ c.image }}"
																data-src-hover="{{ c.image_hover }}"
																data-tooltip="{{ c.name }}">
																<span style="background-color: {{ c.code }};"></span>
																</a>
															</li>
															{% endfor %}
														</ul>
													</div>
												</div>
											</div>
										</div>
										{% endfor %}
									</div>
								</section>
							</div>
						
						</div>
					</section>
				</div>
			</div>
		</div>
    </main>

{% endblock %}